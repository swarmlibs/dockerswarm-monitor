#!/bin/bash
# Copyright (c) Swarm Library Maintainers.
# SPDX-License-Identifier: MIT

set -e

if [[ -z "${1}" ]]; then
    echo "Usage: $0 <prometheus-config-dir>"
    exit 1
fi

# Alerting configuration with DNS-based service discovery
ALERTING_DNS_NAME=${ALERTING_DNS_NAME}
ALERTING_DNS_TYPE=${ALERTING_DNS_TYPE:-"A"}
ALERTING_DNS_PORT=${ALERTING_DNS_PORT:-"9093"}
ALERTING_DNS_REFRESH_INTERVAL=${ALERTING_DNS_REFRESH_INTERVAL:-"30s"}

if [[ -z "${ALERTING_DNS_NAME}" ]]; then
    echo "==> Alerting is not enabled, skipping alerting configuration..."
    exit 0
fi

# Generate alerting configuration
echo "==> Generating alerting configuration..."
cat <<EOF > "${1}"
alerting:
  alertmanagers:
    - dns_sd_configs:
        - names: ['${ALERTING_DNS_NAME}']
          type: '${ALERTING_DNS_TYPE}'
          port: ${ALERTING_DNS_PORT}
          refresh_interval: '${ALERTING_DNS_REFRESH_INTERVAL}'
EOF

exit 0
